[build]
  command = "pnpm run build:netlify"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  PNPM_VERSION = "10.14.0"
  NODE_MODULES_CACHE = "false"
  PRISMA_QUERY_ENGINE_TYPE = "binary"
  PRISMA_FORCE_DOWNLOAD = "1"
  PRISMA_SKIP_MIGRATE = "1"
  # Keep feature flags identical across contexts by default
  FEATURE_IDEMPOTENCY_GATE = "enforce"
  # New: tell Netlify to install devDependencies even though NODE_ENV=production
  NPM_FLAGS = "--include=dev"
  # Invite codes for access control
  INVITE_CODE = "staging2024"
  NEXT_PUBLIC_APP_ENV = "development"
  # Essential Prisma configuration
  FEATURE_BILLING_ENABLED = "false"  # until Stripe/config is ready
  # Enable demo auth in production
  ENABLE_DEMO_AUTH = "1"
  NEXT_PUBLIC_ENABLE_DEMO_AUTH = "1"
  AI_ADAPT_FEEDBACK = "1"
  # Ensure proper database connectivity
  DATABASE_CONNECTION_LIMIT = "10"
  DATABASE_POOL_TIMEOUT = "20"
  # Ensure consistent production behavior
  NODE_ENV = "production"
  NEXT_PUBLIC_CRM_DEBUG = "0"
  NEXT_PUBLIC_CRM_LIGHT_ENABLED = "false"
  # Cache busting for this deployment
  BUILD_TIMESTAMP = "2025-01-27T22:15:00Z"
  # Chrome/Chromium configuration for PDF generation
  CHROME_EXECUTABLE_PATH = "/opt/buildhome/node-deps/node_modules/@sparticuz/chromium/bin"
  # Alternative: Use Netlify's managed Chrome
  # CHROME_EXECUTABLE_PATH = "/opt/buildhome/.netlify/functions/chrome"
  # Email safety configuration
  ALLOW_DEV_EMAILS = ".*@(yourdomain\\.com|test\\.com|example\\.com|localhost)$"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# Function configuration for media pack generation
[functions."/api/media-pack/generate"]
  timeout = 120
  memory = 1024

# Function configuration for other heavy operations
[functions."/api/audit/run"]
  timeout = 120
  memory = 1024

[functions."/api/outreach/queue"]
  timeout = 60
  memory = 1024

# Production (main) â€“ this is controlled by Netlify "Production branch" in UI
[context.production]
  command = "pnpm run build:netlify"

[context.production.environment]
  INVITE_CODE = "main2024"
  NEXT_PUBLIC_APP_ENV = "production"
  FEATURE_IDEMPOTENCY_GATE = "enforce"

# Branch deploys
[context."branch:dev"]
  command = "pnpm run build:netlify"

[context."branch:dev".environment]
  INVITE_CODE = "dev2024"
  NEXT_PUBLIC_APP_ENV = "development"

[context."branch:staging"]
  command = "pnpm run build:netlify"

[context."branch:staging".environment]
  INVITE_CODE = "staging2024"
  NEXT_PUBLIC_APP_ENV = "staging"

[context."branch:prod"]
  command = "pnpm run build:netlify"

[context."branch:prod".environment]
  INVITE_CODE = "prod2024"
  NEXT_PUBLIC_APP_ENV = "production"

# Catch-all for other branches if needed
[context.branch-deploy]
  command = "pnpm run build:netlify"

# Deploy preview context
[context.deploy-preview]
  command = "pnpm run build:netlify"

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
  X-Frame-Options = "DENY"
  X-XSS-Protection = "1; mode=block"
  X-Content-Type-Options = "nosniff"
  Referrer-Policy = "strict-origin-when-cross-origin"
  Cache-Control = "no-cache, no-store, must-revalidate"
  Pragma = "no-cache"
  Expires = "0"
  # CSP trimmed for brevity; keep your existing allowlists
  Content-Security-Policy = "default-src 'self'; img-src 'self' data: https://logo.clearbit.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://logo.clearbit.com; frame-ancestors 'none'; base-uri 'self'"

[[headers]]
  for = "/_next/static/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_next/image/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

# API routes caching
[[headers]]
  for = "/api/*"
  [headers.values]
  Cache-Control = "no-store"