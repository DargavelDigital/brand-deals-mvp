name: Migration Smoke
on:
  pull_request:
    paths: [ 'prisma/**' ]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'pnpm' }
      - run: corepack enable && pnpm i --frozen-lockfile
      
      - name: Spin ephemeral Postgres
        run: |
          docker run -d --name postgres-test \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=postgres \
            -p 5432:5432 \
            postgres:15
          sleep 10
          
      - name: Apply migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: pnpm migrate:deploy && pnpm db:smoke
        
      - name: Cleanup
        if: always()
        run: docker stop postgres-test && docker rm postgres-test
